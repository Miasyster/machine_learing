# 机器学习驱动量化策略框架

本框架面向构建一个可复现、可回测、可线上交易（可扩展至多品种、多周期）的**机器学习驱动量化策略**。目标是把数据获取、特征工程、模型训练/评估、回测、风控与实盘执行串成一条工程化流水线，支持实验管理与持续迭代。

---

## 📋 项目进度清单

### 🎯 核心模块

- [x] **1. 目标与约束** - 策略目标、频率、资产定义
- [x] **2. 数据与存储** - 一级行情数据获取与存储
- [ ] **3. 数据工程** - ETL/清洗/对齐流水线
- [ ] **4. 特征工程** - 因子设计、滞后、归一化
- [ ] **5. 标签构建** - 目标变量、持仓周期
- [ ] **6. 模型与训练** - 算法、训练流程、超参数
- [ ] **7. 回测引擎** - 交易逻辑、手续费、滑点
- [ ] **8. 风控与组合管理** - 仓位管理、风险限额
- [ ] **9. 实盘/执行** - 撮合、委托、监控
- [ ] **10. 评估与监控** - 指标、告警、可视化
- [ ] **11. 工程化与部署** - CI/CD, 数据版本, 实验追踪

### 🔧 基础设施

- [x] **项目结构** - 标准化目录结构
- [x] **测试框架** - pytest测试环境
- [x] **依赖管理** - requirements.txt
- [ ] **配置管理** - 策略配置文件
- [ ] **实验追踪** - MLflow集成
- [ ] **容器化** - Docker配置

---

## ✅ 1. 目标与约束

- [x] **策略类型**：价差/趋势/反转/因子加权/强化学习（任选）
- [x] **交易频率**：日内/日级/分钟级/高频（明确频率以决定数据与执行复杂度）
- [x] **资产**：股票/期货/外汇/加密（不同资产对滑点、手续费、可交易量要求不同）
- [x] **目标**：风险调整后的收益最大化（Sharpe、Sortino），或绝对收益
- [x] **约束**：手续费模型、最大回撤、单日最大损失、单品种持仓限制

---

## ✅ 2. 数据与存储

### 数据来源

- [x] **一级行情**：交易所、券商API（历史bar、tick）
- [ ] **基础面**：财报、因子库（如风控因子、基本面因子）
- [ ] **事件数据**：经济日历、公告
- [ ] **衍生**：成交量簿、委托簿（若高频）

### 存储方案

- [x] **冷存（历史量大）**：对象存储或分区文件系统（Parquet）
- [ ] **热存（实时/近实时）**：TimescaleDB/ClickHouse/InfluxDB
- [ ] **元数据与实验**：Postgres + MLflow/Weights & Biases

---

## 🔄 3. 数据工程（ETL）

- [ ] **抽取（Extract）**：统一抓取接口（适配不同API），并写入原始目录
- [ ] **清洗（Clean）**：缺失填充、异常值处理、对齐时序（对tick或bar做时间桶）
- [ ] **衍生（Transform）**：计算移动平均、波动、成交量相关指标等
- [ ] **验证（Validation）**：数据完整性检查（日期连续性、开盘/收盘逻辑）、回溯一致性
- [ ] **自动化**：每天/分钟的流水线（Airflow / Prefect / Dagster）

---

## 🔧 4. 特征工程

- [ ] **因子类型**：技术因子（MA、RSI、ADX）、统计因子（z-score, rolling skew）、成交量因子、波动率因子、异构数据因子（新闻情绪）
- [ ] **时间维度**：多周期特征（1m, 5m, 1h, 1d）与滞后特征
- [ ] **防止信息泄露**：只使用当时可用数据来构建特征（严格对齐）
- [ ] **标准化**：按品种分组的滚动z-score或分位数化（避免跨品种尺度问题）
- [ ] **特征筛选**：相关性过滤、基于模型的重要性、LASSO或SHAP

---

## 🏷️ 5. 标签构建

- [ ] **常见标签**：未来N日/分钟的收益率、方向（+1/0/-1）、超额收益（相对基准）
- [ ] **多目标**：收益最大化 + 风控（例如同时预测涨幅和波动）
- [ ] **执行一致性**：确定持仓期与平仓规则，标签应该与最终执行逻辑一致

---

## 🤖 6. 模型与训练

### 候选模型

- [ ] **传统模型**：Logistic/Linear回归、随机森林、XGBoost、LightGBM
- [ ] **深度学习**：MLP、CNN（序列特征）、RNN/LSTM、Transformer、Temporal Fusion Transformer
- [ ] **强化学习**：DDPG、PPO（仅当有可靠模拟器）

### 训练流程

- [ ] **数据划分**：训练/验证/测试（时间序列交叉验证，walk-forward）
- [ ] **数据增强**：平衡样本、噪声注入
- [ ] **超参数搜索**：Optuna/BayesOpt
- [ ] **模型校准与集成**：stacking/blending
- [ ] **模型解释**：SHAP、特征重要性

---

## 📊 7. 回测引擎

- [ ] **核心要点**：按实际撮合顺序模拟成交、考虑滑点、手续费、最小下单量、撮合延迟
- [ ] **回测方式**：逐tick回测（高精度，慢）、按bar回测（快但粗糙）
- [ ] **事务管理**：开平仓、仓位限制、止损/止盈、持仓过夜逻辑
- [ ] **性能优化**：使用向量化回测框架或C++/Rust加速关键路径
- [ ] **工具选择**：backtrader、zipline、bt、自研引擎（生产环境推荐自研以支持实盘一致性）

---

## 🛡️ 8. 风控与组合管理

- [ ] **单策略风险**：最大回撤、VAR、单日损失限额
- [ ] **多策略/多品种**：相关性控制、因子中性化、风险平价或最大化夏普的权重求解
- [ ] **仓位管理**：Kelly/固定比例/波动率调仓
- [ ] **交易成本预算**：手续费、滑点、融资费（期货保证金/利息）

---

## 🚀 9. 实盘与执行

- [ ] **落地方式**：券商API、FIX、交易所SDK
- [ ] **委托策略**：市价、限价、冰山、TWAP/VWAP
- [ ] **监控系统**：订单状态、成交确认、对账
- [ ] **容错机制**：自动重连、幂等委托、回滚策略

---

## 📈 10. 评估与监控

- [ ] **回测指标**：累计收益、年化收益、年化波动、Sharpe、最大回撤、Calmar、胜率、平均盈亏比
- [ ] **实时监控**：每日净值、实时暴露、未平仓盈亏、成交延迟分布
- [ ] **告警系统**：超过阈值的损失、模型漂移、数据缺失、延迟
- [ ] **可视化**：Grafana/Prometheus + 前端Dashboard

---

## 🔧 11. 工程化与部署

- [ ] **实验管理**：MLflow/W&B记录参数、模型、数据版本、实验结果
- [ ] **模型注册与A/B测试**：模型仓库、灰度发布、回滚
- [ ] **CI/CD**：单元测试、集成测试、回测回归测试（保证策略行为稳定）
- [ ] **基础设施**：容器化（Docker）、Kubernetes for scaling

---

## 🛠️ 12. 技术栈建议 & 目录结构

### 技术栈

- [x] **语言/库**：Python, pandas/Polars, numpy, scikit-learn, lightgbm/xgboost, pytorch/tensorflow
- [x] **数据存储**：Parquet, ClickHouse, Postgres
- [ ] **流水线**：Airflow / Prefect
- [ ] **实验管理**：MLflow, Optuna
- [ ] **回测框架**：自研或 backtrader
- [ ] **部署**：Docker, Kubernetes
- [ ] **消息/队列**：Kafka / Redis
- [ ] **监控**：Prometheus + Grafana

### 目录结构

- [x] **项目结构**：标准化目录结构已建立
```
project/
├─ data/                 # 原始与处理后数据（parquet）
├─ notebooks/            # 探索性分析
├─ src/
│  ├─ etl/               # 数据抽取/清洗脚本
│  ├─ features/          # 特征工程模块
│  ├─ models/            # 模型训练与保存
│  ├─ backtest/          # 回测引擎/策略实现
│  ├─ execution/         # 实盘/委托模块
│  ├─ tests/             # 单元与回测回归测试
│  └─ utils/
├─ configs/              # 参数、策略配置
├─ experiments/          # mlflow 或实验记录
└─ infra/                # docker, k8s manifests
```

---

## 🎯 13. 里程碑与交付物

### 开发里程碑

- [x] **M0（已完成）** - 项目结构、数据接入、测试框架
- [ ] **M1（2周）** - 需求确认、数据接入、样例数据集
- [ ] **M2（3周）** - 基本特征与标签、baseline模型（LightGBM）
- [ ] **M3（3周）** - 回测引擎对接、回测结果稳定化
- [ ] **M4（2周）** - 风控与仓位管理模块
- [ ] **M5（2周）** - 实盘桥接（模拟/小资金灰度）与监控告警

### 交付物

- [x] **文档**：项目README、测试说明
- [ ] **可复现代码仓**：完整的代码库
- [ ] **回测报告**：策略性能分析
- [ ] **实盘监控面板**：实时监控系统

---

---

## 🚀 快速开始

### 当前可用功能

- [x] **数据获取**：币安API数据抓取
- [x] **数据存储**：Parquet格式存储
- [x] **测试框架**：完整的测试环境

### 运行测试

```bash
# 运行所有测试
python run_tests.py

# 快速测试
python run_tests.py --quick

# 查看帮助
python run_tests.py --help
```

### 数据流程示例

```python
# 数据加载 -> 特征生成 -> 时间序列切分（train/val/test） 
# -> 训练LightGBM -> walk-forward回测 -> 保存模型
# -> 实盘服务加载模型，周期性预测并下单
```

---

## 📝 开发建议

- [x] **从简单开始**：先做单品种、日内或日级策略的baseline，确保数据和回测链路正确
- [ ] **重视工程**：生产一致性（回测与实盘使用同一套价格/滑点假设、同一仓位计算）
- [ ] **实验追踪与可回溯性**：任何改动都应能回溯到数据快照和模型版本

---

## 🔄 下一步计划

1. **数据工程**：完善ETL流水线，添加数据质量检查
2. **特征工程**：实现技术指标和统计特征
3. **模型训练**：集成LightGBM/XGBoost baseline模型
4. **回测引擎**：开发向量化回测框架
5. **监控系统**：建立实时监控和告警机制

---

*最后更新：2024年12月*
